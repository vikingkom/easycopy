version: '3.8'

services:
  easycopy-server:
    image: vikingkom/easycopy-server:latest
    restart: unless-stopped
    environment:
      - TZ=UTC
    container_name: easycopy-server
    networks:
      - easycopy-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./server/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ssl-certs:/etc/nginx/ssl:ro
    depends_on:
      - easycopy-server
    restart: unless-stopped
    container_name: easycopy-nginx
    networks:
      - easycopy-network
    environment:
      - SSL_DOMAIN=${SSL_DOMAIN:-localhost}

  certbot:
    image: alpine:latest
    volumes:
      - ssl-certs:/etc/nginx/ssl
    entrypoint: /bin/sh
    command: >
      -c "
      apk add --no-cache openssl &&
      if [ ! -f /etc/nginx/ssl/server.crt ]; then
        echo 'Generating self-signed SSL certificate...' &&
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
          -keyout /etc/nginx/ssl/server.key \
          -out /etc/nginx/ssl/server.crt \
          -subj '/C=US/ST=State/L=City/O=EasyCopy/CN='$${SSL_DOMAIN:-localhost} \
          -addext 'subjectAltName=DNS:'$${SSL_DOMAIN:-localhost}',DNS:localhost,IP:127.0.0.1' &&
        chmod 600 /etc/nginx/ssl/server.key &&
        chmod 644 /etc/nginx/ssl/server.crt &&
        echo 'SSL certificates generated successfully';
      else
        echo 'SSL certificates already exist';
      fi
      "
    networks:
      - easycopy-network
    environment:
      - SSL_DOMAIN=${SSL_DOMAIN:-localhost}

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - TZ=UTC
    command: --interval 300 --cleanup
    networks:
      - easycopy-network

volumes:
  ssl-certs:

networks:
  easycopy-network:
    driver: bridge